{
  "name": "ashley-scraper",
  "slug": "ashley-scraper",
  "verify_jwt": false,
  "entrypoint_path": "index.ts",
  "files": [
    {
      "name": "index.ts",
      "content": "import \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\nimport { createClient } from \"npm:@supabase/supabase-js@2.57.4\";\n\nconst corsHeaders = {\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Methods\": \"GET, POST, OPTIONS\",\n  \"Access-Control-Allow-Headers\": \"Content-Type, Authorization, X-Client-Info, Apikey\",\n};\n\nconst SCRAPER_API_KEY = \"1cd1284bc7d418a0eb88bbebd8cd46d1\";\n\ninterface ListingProduct {\n  name: string;\n  price: number;\n  sku: string;\n  url: string;\n}\n\ninterface DetailedProduct extends ListingProduct {\n  description: string;\n  images: string[];\n}\n\nfunction parseListingPage(html: string): ListingProduct[] {\n  const products: ListingProduct[] = [];\n  const seenSkus = new Set<string>();\n\n  console.log(\"\\n=== PARSING LISTING PAGE ===\");\n  console.log(`HTML length: ${html.length}`);\n\n  const nameLinkPattern = /<a[^>]*class=\"[^\"]*name-link[^\"]*\"[^>]*href=\"([^\"]*)\"[^>]*title=\"[^\"]*?:\\s*([^\"]*)\"[^>]*>/gi;\n  let match;\n\n  while ((match = nameLinkPattern.exec(html)) !== null) {\n    const url = match[1];\n    const name = match[2].trim();\n    const skuMatch = url.match(/\\/(\\d+)\\.html/);\n    const sku = skuMatch ? skuMatch[1] : \"\";\n\n    if (sku && !seenSkus.has(sku)) {\n      seenSkus.add(sku);\n\n      const tileRegex = new RegExp(\n        `data-pid=\"${sku}\"[^>]*>([\\\\s\\\\S]*?)(?=data-pid=\"|$)`,\n        \"i\"\n      );\n      const tileMatch = html.match(tileRegex);\n      const tileContent = tileMatch ? tileMatch[1] : \"\";\n\n      const pricePatterns = [\n        /class=\"[^\"]*sales[^\"]*\"[^>]*>\\s*<span[^>]*>\\s*\\$\\s*([\\d,]+(?:\\.\\d{2})?)/i,\n        /\\$\\s*([\\d,]+(?:\\.\\d{2})?)/,\n      ];\n\n      let price = 0;\n      for (const pattern of pricePatterns) {\n        const priceMatch = tileContent.match(pattern);\n        if (priceMatch) {\n          price = parseFloat(priceMatch[1].replace(/,/g, \"\"));\n          if (price > 0) break;\n        }\n      }\n\n      const fullUrl = url.startsWith(\"http\") ? url : `https://www.ashleyfurniture.com${url}`;\n\n      products.push({\n        name,\n        sku,\n        price: price || 999,\n        url: fullUrl,\n      });\n\n      console.log(`Found: ${name} (${sku}) - $${price || 999}`);\n    }\n  }\n\n  console.log(`\\n=== TOTAL: ${products.length} products found ===\\n`);\n  return products;\n}\n\nfunction parseDetailPage(html: string, sku: string): { description: string; images: string[] } {\n  console.log(`\\n=== PARSING DETAIL PAGE FOR ${sku} ===`);\n\n  let description = \"\";\n  const descPatterns = [\n    /<div[^>]*class=\"[^\"]*description[^\"]*\"[^>]*>([\\s\\S]*?)<\\/div>/i,\n    /<meta[^>]*property=\"og:description\"[^>]*content=\"([^\"]*)"/i,\n    /<p[^>]*class=\"[^\"]*product-description[^\"]*\"[^>]*>([\\s\\S]*?)<\\/p>/i,\n  ];\n\n  for (const pattern of descPatterns) {\n    const match = html.match(pattern);\n    if (match && match[1]) {\n      description = match[1]\n        .replace(/<[^>]*>/g, \" \")\n        .replace(/\\s+/g, \" \")\n        .trim();\n      if (description.length > 50) break;\n    }\n  }\n\n  if (!description) {\n    description = `Premium Ashley Furniture sofa featuring quality craftsmanship and modern design.`;\n  }\n\n  const images: string[] = [];\n  const imagePatterns = [\n    new RegExp(`${sku}_[A-Z0-9]+_[A-Z0-9]+`, \"gi\"),\n    /ashleyfurniture\\.scene7\\.com\\/is\\/image\\/AshleyFurniture\\/([^\"?]+)/gi,\n  ];\n\n  const imageIds = new Set<string>();\n\n  for (const pattern of imagePatterns) {\n    let match;\n    while ((match = pattern.exec(html)) !== null) {\n      const imageId = match[0].includes(\"scene7\") ? match[1] : match[0];\n      if (imageId && !imageIds.has(imageId)) {\n        imageIds.add(imageId);\n        const highResUrl = `https://ashleyfurniture.scene7.com/is/image/AshleyFurniture/${imageId}?wid=1200&hei=1200&fmt=jpg`;\n        images.push(highResUrl);\n        if (images.length >= 5) break;\n      }\n    }\n    if (images.length >= 5) break;\n  }\n\n  if (images.length === 0) {\n    const fallbackViews = [\"FRONT\", \"QUILL_QUILL\", \"LEFT\", \"RIGHT\", \"LIFESTYLE\"];\n    for (const view of fallbackViews) {\n      images.push(`https://ashleyfurniture.scene7.com/is/image/AshleyFurniture/${sku}_${view}_${view}?wid=1200&hei=1200&fmt=jpg`);\n    }\n  }\n\n  console.log(`Description: ${description.substring(0, 100)}...`);\n  console.log(`Images found: ${images.length}`);\n\n  return { description, images };\n}\n\nasync function fetchViaScraperApi(targetUrl: string): Promise<string> {\n  const scraperUrl = `http://api.scraperapi.com?api_key=${SCRAPER_API_KEY}&url=${encodeURIComponent(targetUrl)}&render=true&country_code=us`;\n\n  console.log(`\\nFetching: ${targetUrl}`);\n\n  const response = await fetch(scraperUrl, {\n    method: \"GET\",\n    headers: {\n      \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\",\n    },\n  });\n\n  if (!response.ok) {\n    const errorText = await response.text();\n    console.error(`ScraperAPI error: ${errorText.substring(0, 300)}`);\n    throw new Error(`ScraperAPI failed: ${response.status}`);\n  }\n\n  const html = await response.text();\n  console.log(`Received ${html.length} characters`);\n\n  return html;\n}\n\nasync function getProductDetails(product: ListingProduct): Promise<DetailedProduct> {\n  try {\n    const detailHtml = await fetchViaScraperApi(product.url);\n    const { description, images } = parseDetailPage(detailHtml, product.sku);\n\n    return {\n      ...product,\n      description,\n      images,\n    };\n  } catch (error: any) {\n    console.error(`Failed to fetch details for ${product.sku}: ${error.message}`);\n    return {\n      ...product,\n      description: `Premium Ashley Furniture ${product.name}`,\n      images: [\n        `https://ashleyfurniture.scene7.com/is/image/AshleyFurniture/${product.sku}_FRONT_FRONT?wid=1200&hei=1200&fmt=jpg`,\n        `https://ashleyfurniture.scene7.com/is/image/AshleyFurniture/${product.sku}_QUILL_QUILL?wid=1200&hei=1200&fmt=jpg`,\n      ],\n    };\n  }\n}\n\nDeno.serve(async (req: Request) => {\n  if (req.method === \"OPTIONS\") {\n    return new Response(null, { status: 200, headers: corsHeaders });\n  }\n\n  try {\n    const body = await req.json();\n    const { pageNum, rawHtml, importToDb = true } = body;\n    const authHeader = req.headers.get(\"Authorization\");\n\n    console.log(`\\n${\"=\".repeat(60)}`);\n    console.log(`ASHLEY SCRAPER - PAGE ${pageNum} (Enhanced)`);\n    console.log(\"=\".repeat(60));\n\n    if (!pageNum || pageNum < 1 || pageNum > 20) {\n      return new Response(\n        JSON.stringify({ error: \"Provide pageNum (1-20)\" }),\n        { status: 400, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    const startParam = (pageNum - 1) * 30;\n    const listingUrl = pageNum === 1\n      ? \"https://www.ashleyfurniture.com/c/furniture/living-room/sofas/\"\n      : `https://www.ashleyfurniture.com/c/furniture/living-room/sofas/?start=${startParam}&sz=30`;\n\n    console.log(\"\\nSTEP 1: Fetching listing page...\");\n    const listingHtml = await fetchViaScraperApi(listingUrl);\n    const listingProducts = parseListingPage(listingHtml);\n\n    if (listingProducts.length === 0) {\n      return new Response(\n        JSON.stringify({ success: false, error: \"No products found on listing page\" }),\n        { status: 400, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    console.log(`\\nSTEP 2: Fetching details for ${listingProducts.length} products...`);\n    const detailedProducts: DetailedProduct[] = [];\n\n    for (let i = 0; i < listingProducts.length; i++) {\n      const product = listingProducts[i];\n      console.log(`\\n[${i + 1}/${listingProducts.length}] Processing ${product.name}...`);\n\n      const detailed = await getProductDetails(product);\n      detailedProducts.push(detailed);\n\n      await new Promise(resolve => setTimeout(resolve, 500));\n    }\n\n    if (!importToDb) {\n      return new Response(\n        JSON.stringify({\n          success: true,\n          products: detailedProducts,\n          count: detailedProducts.length,\n        }),\n        { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n      );\n    }\n\n    console.log(\"\\n=== STEP 3: IMPORTING TO DATABASE ===\");\n\n    const supabaseUrl = Deno.env.get(\"SUPABASE_URL\")!;\n    const supabaseKey = authHeader?.replace(\"Bearer \", \"\") || Deno.env.get(\"SUPABASE_ANON_KEY\")!;\n    const supabase = createClient(supabaseUrl, supabaseKey);\n\n    const { data: category } = await supabase\n      .from(\"categories\")\n      .select(\"id\")\n      .eq(\"slug\", \"sofas\")\n      .maybeSingle();\n\n    console.log(`Category ID: ${category?.id || \"NOT FOUND\"}`);\n\n    let succeeded = 0;\n    let updated = 0;\n    let failed = 0;\n    const errors: string[] = [];\n\n    for (let i = 0; i < detailedProducts.length; i++) {\n      const product = detailedProducts[i];\n      try {\n        const { data: existing } = await supabase\n          .from(\"products\")\n          .select(\"id\")\n          .eq(\"sku\", product.sku)\n          .maybeSingle();\n\n        if (existing) {\n          console.log(`${i + 1}/${detailedProducts.length} UPDATING: ${product.name}`);\n\n          await supabase\n            .from(\"products\")\n            .update({\n              description: product.description,\n              price: product.price,\n            })\n            .eq(\"id\", existing.id);\n\n          await supabase\n            .from(\"product_images\")\n            .delete()\n            .eq(\"product_id\", existing.id);\n\n          for (let imgIdx = 0; imgIdx < product.images.length; imgIdx++) {\n            await supabase.from(\"product_images\").insert({\n              product_id: existing.id,\n              image_url: product.images[imgIdx],\n              display_order: imgIdx,\n            });\n          }\n\n          console.log(`  ✓ Updated with ${product.images.length} images`);\n          updated++;\n        } else {\n          const slug = product.name\n            .toLowerCase()\n            .replace(/[^a-z0-9]+/g, \"-\")\n            .replace(/^-|-$/g, \"\");\n\n          const { data: newProduct, error: productError } = await supabase\n            .from(\"products\")\n            .insert({\n              name: product.name,\n              slug: `${slug}-${product.sku.toLowerCase()}`,\n              sku: product.sku,\n              price: product.price,\n              description: product.description,\n              category_id: category?.id || null,\n              stock_quantity: 10,\n              status: \"active\",\n            })\n            .select()\n            .single();\n\n          if (productError || !newProduct) {\n            console.error(`${i + 1}/${detailedProducts.length} FAIL: ${productError?.message}`);\n            errors.push(`${product.name}: ${productError?.message}`);\n            failed++;\n            continue;\n          }\n\n          for (let imgIdx = 0; imgIdx < product.images.length; imgIdx++) {\n            await supabase.from(\"product_images\").insert({\n              product_id: newProduct.id,\n              image_url: product.images[imgIdx],\n              display_order: imgIdx,\n            });\n          }\n\n          console.log(`${i + 1}/${detailedProducts.length} ✓ CREATED: ${product.name} with ${product.images.length} images`);\n          succeeded++;\n        }\n      } catch (error: any) {\n        console.error(`${i + 1}/${detailedProducts.length} ERROR:`, error.message);\n        errors.push(error.message);\n        failed++;\n      }\n    }\n\n    console.log(`\\n${\"=\".repeat(60)}`);\n    console.log(`SUMMARY: ${succeeded} new, ${updated} updated, ${failed} failed`);\n    console.log(\"=\".repeat(60));\n\n    return new Response(\n      JSON.stringify({\n        success: true,\n        total: detailedProducts.length,\n        succeeded,\n        updated,\n        failed,\n        errors: errors.slice(0, 5),\n      }),\n      { headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n    );\n  } catch (error: any) {\n    console.error(\"FATAL:\", error);\n    return new Response(\n      JSON.stringify({ success: false, error: error.message }),\n      { status: 500, headers: { ...corsHeaders, \"Content-Type\": \"application/json\" } }\n    );\n  }\n});"
    }
  ]
}
